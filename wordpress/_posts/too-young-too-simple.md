title: 'Too young Too simple|填坑汇总'
id: 1590
categories:
  - 算法/数据结构
date: 2015-08-31 00:23:11
tags:
---

[note]
因为第一次出来实习，瞬间感觉以前对用户体验关注过少的Demo什么的都弱爆了，各种要求一上来，就需要各种奇怪的姿势来处理，接着就挖出了一个个坑，有些已经解决了，有些不明觉厉换方案处理了。不管怎么样，坑还是要先记下来的，一个个来看~
[/note]

# PopupWindow: 硬件加速你快回来，你快回来，猝！

因为业务需求，使用了PopupWindow，但是开发到一半发现图片切换非常之卡。
打开Android对函数调用监控，发现耗时最多的是drawBitmap！！！
开发人员工具监控gpu，发现gpu无作为，然后意识到drawBitmap是cpu的绘制函数。
可是为什么是cpu绘图！！！为什么是cpu绘图！！！为什么是cpu绘图！！！（已经在window级别开启了硬件加速）修改代码查看PopWindow显示的View的硬件加速是否开启，果不其然硬件加速被关了。
担心是手淘架构的影响，自己又新建了个Demo排除了是手淘的问题，接着在自己的Demo开启全程序硬件加速，发现Activity中其他元素都已经是硬件加速状态，然后去google官网恶补了一下硬件加速和PopupWindow知识，还是没想明白为什么会失效，倒是打消了我给View单独开硬件的想法（目前不支持在View级别开启硬件加速，只支持关闭），打开PopupWindow的源码也没看到有自己关掉硬件加速。
无奈，只好换Activity作为载体，似乎有点重了，不过PopupWindow没法使用硬件加速影响更大。
---------------------------------------------------------------
9.1凌晨更新
再次去了解了下WindowManager机制，似乎发现了什么，这是个系统级服务，即使Token是Activity所在Window的，也不代表View在那个Window里。同时注意到，窗口所使用的动画设置。它必须是一个系统资源而不是应用程序资源，因为窗口管理器不能访问应用程序。这么说直接向WindowManager中添加的View很可能是不属于Application的。大致有了一个方向，具体的之后再看，明天还得早起呢~

# 小米等系统的权限确认框导致Touch事件丢失

实现语音聊天的过程中，按下录音Button，需要开始录音，松开则需要停止。在小米这样系统被深度定制的系统上，第一次进行录音会弹出一个权限确认框，接着ACTION_UP事件就被权限确认框给吃掉了，导致整个流程异常。目前的解决方案是判断权限框阻塞的那行代码的执行事件，期待找到更好的方法。